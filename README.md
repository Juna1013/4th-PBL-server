# テレメトリシステム

ラズピコWからセンサーとモーターの状態を外部サーバーにリアルタイムで送信するシステム

## 構成

### 1. ラズピコW側プログラム
**ファイル**: `firmware/src/main.py`

ライントレースを実行しながら、以下のデータを定期的にサーバーに送信：
- センサー値（8個のラインセンサー）
- モーター速度（左右）
- 制御パラメータ（エラー値、ターン値）
- WiFi情報（IPアドレス、信号強度）

### 2. サーバー側プログラム
**ファイル**: `server/telemetry_server.py`

テレメトリデータを受信・表示・保存するFlaskサーバー

## セットアップ

### 1. config.pyの準備

`firmware/src/config.py`を作成（まだ存在しない場合）：

```python
# WiFi設定
SSID = "your_wifi_ssid"
PASSWORD = "your_wifi_password"

# サーバー設定
SERVER_IP = "192.168.1.100"  # サーバーのIPアドレス
```

### 2. サーバー側の準備

```bash
# 必要なパッケージをインストール
pip install flask

# サーバーを起動
cd server
python telemetry_server.py
```

サーバーが起動したら、ブラウザで `http://localhost:8000` を開いてダッシュボードにアクセスできます。

### 3. ラズピコWへのデプロイ

1. `firmware/src/`内のすべてのファイルをラズピコWにコピー
2. ラズピコWで実行：
   ```python
   import main
   ```

## 送信データ形式

```json
{
  "timestamp": 12345,
  "sensors": [1, 1, 0, 0, 0, 1, 1, 1],
  "motor": {
    "left_speed": 6160,
    "right_speed": 8000
  },
  "control": {
    "error": -1.5,
    "turn": -10500,
    "base_speed": 8000
  },
  "wifi": {
    "ip": "192.168.1.101",
    "rssi": -45
  }
}
```

## サーバーエンドポイント

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/` | ダッシュボード（ブラウザで開く） |
| GET | `/ping` | 接続テスト |
| POST | `/telemetry` | テレメトリデータ受信 |
| GET | `/telemetry/latest` | 最新データ取得 |
| GET | `/telemetry/history?count=10` | 履歴取得 |
| GET | `/telemetry/export` | データエクスポート |
| POST | `/telemetry/clear` | 履歴クリア |

## ダッシュボード機能

ブラウザで `http://サーバーIP:8000` にアクセスすると、以下の情報がリアルタイムで表示されます：

- **ラインセンサー**: 8つのセンサーの状態（白/黒）
- **モーター速度**: 左右のモーター速度（バー表示）
- **制御情報**: エラー値、ターン値、ベース速度
- **WiFi情報**: IPアドレス、信号強度
- **統計情報**: 平均エラー値、最大速度、稼働時間

## パラメータ調整

### 送信間隔の変更

`firmware/src/main.py`の34行目：
```python
TELEMETRY_INTERVAL_MS = 500  # ミリ秒単位（500ms = 0.5秒）
```

- **高頻度送信**: `200`〜`300`（より詳細なデータ、WiFi負荷増）
- **低頻度送信**: `1000`〜`2000`（WiFi負荷軽減、データ粗め）

### サーバーポートの変更

両方のファイルで同じポート番号を使用してください：
- `telemetry_server.py`: 最終行の`port=8000`
- `firmware/src/main.py`: 35行目の`:8000`

## トラブルシューティング

### WiFi接続できない
- `config.py`のSSIDとパスワードを確認
- WiFiルーターの2.4GHz帯を使用（ラズピコWは5GHz非対応）

### サーバーに接続できない
- サーバーのIPアドレスが正しいか確認
- ファイアウォールで8000番ポートが開いているか確認
- サーバーとラズピコWが同じネットワークにいるか確認

### データが送信されない
- サーバーのログを確認
- ラズピコWのコンソール出力を確認
- `TELEMETRY_INTERVAL_MS`が適切か確認

## ファイル構成

```
server/
├── telemetry_server.py    # Flaskサーバー
├── templates/
│   └── dashboard.html     # ダッシュボードUI
├── docs/                  # ドキュメント
└── TELEMETRY.md          # このファイル
```

## 今後の拡張案

- [ ] WebSocketによるリアルタイム双方向通信
- [ ] データベースへの永続化
- [ ] アラート機能（異常検知時の通知）
- [ ] リモート制御機能（パラメータの動的変更）
- [ ] グラフ表示（時系列データの可視化）
# 4th-PBL-server
